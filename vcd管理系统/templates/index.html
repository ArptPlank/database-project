{% extends "base.html" %}

{% block title %}ä¸»é¡µ - éŸ³åƒåº—VCDç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-center text-primary mb-3">
                <i class="fas fa-compact-disc me-3"></i>éŸ³åƒåº—VCDç®¡ç†ç³»ç»Ÿ
            </h1>
            <p class="lead text-center text-muted">
                å…¨é¢çš„VCDé›¶å”®ä¸å‡ºç§Ÿç®¡ç†è§£å†³æ–¹æ¡ˆ
            </p>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-3" id="statsCards">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-compact-disc fa-2x mb-3"></i>
                    <h4 class="card-title">VCDæ€»æ•°</h4>
                    <h2 class="display-6" id="totalVcds">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-boxes fa-2x mb-3"></i>
                    <h4 class="card-title">ç°è´§æ•°é‡</h4>
                    <h2 class="display-6" id="availableVcds">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-handshake fa-2x mb-3"></i>
                    <h4 class="card-title">å€Ÿå‡ºæ•°é‡</h4>
                    <h2 class="display-6" id="rentedVcds">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart fa-2x mb-3"></i>
                    <h4 class="card-title">ä»Šæ—¥é”€å”®</h4>
                    <h2 class="display-6" id="todaySales">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®çŠ¶æ€å’Œä¿®å¤åŠŸèƒ½ -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">æ•°æ®çŠ¶æ€</h6>
                            <small class="text-muted" id="lastUpdateTime">æ­£åœ¨åŠ è½½...</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-warning btn-sm me-2" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm me-2" onclick="fixAllData()">
                                <i class="fas fa-wrench"></i> ä¿®å¤æ•°æ®
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="resetAllData()">
                                <i class="fas fa-trash-alt"></i> é‡ç½®æ•°æ®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½æ¨¡å— -->
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4 text-center">ç³»ç»ŸåŠŸèƒ½</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-compact-disc fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">VCDä¿¡æ¯ç®¡ç†</h5>
                    <p class="card-text">ç®¡ç†VCDåŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€ç±»å‹ã€ä»·æ ¼ã€å¯¼æ¼”ã€æ¼”å‘˜ç­‰è¯¦ç»†ä¿¡æ¯ã€‚</p>
                    <a href="{{ url_for('vcd_management') }}" class="btn btn-primary">
                        <i class="fas fa-arrow-right me-1"></i>è¿›å…¥ç®¡ç†
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-boxes fa-3x text-success mb-3"></i>
                    <h5 class="card-title">åº“å­˜ç®¡ç†</h5>
                    <p class="card-text">ç®¡ç†VCDåº“å­˜ï¼Œæ”¯æŒå…¥åº“æ“ä½œï¼Œå®æ—¶æŸ¥çœ‹å„ç±»VCDçš„åº“å­˜çŠ¶æ€ã€‚</p>
                    <a href="{{ url_for('inventory_management') }}" class="btn btn-success">
                        <i class="fas fa-arrow-right me-1"></i>æŸ¥çœ‹åº“å­˜
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-shopping-cart fa-3x text-warning mb-3"></i>
                    <h5 class="card-title">é›¶å”®ç®¡ç†</h5>
                    <p class="card-text">å¤„ç†VCDé”€å”®ä¸šåŠ¡ï¼Œè‡ªåŠ¨æ›´æ–°åº“å­˜ï¼Œè®°å½•é”€å”®å†å²ã€‚</p>
                    <a href="{{ url_for('sales_management') }}" class="btn btn-warning">
                        <i class="fas fa-arrow-right me-1"></i>é”€å”®ç®¡ç†
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-handshake fa-3x text-info mb-3"></i>
                    <h5 class="card-title">å€Ÿè¿˜ç®¡ç†</h5>
                    <p class="card-text">ç®¡ç†VCDç§Ÿå€Ÿä¸šåŠ¡ï¼Œè·Ÿè¸ªå€Ÿå‡ºå’Œå½’è¿˜ï¼Œè‡ªåŠ¨è®¡ç®—ç§Ÿé‡‘ã€‚</p>
                    <a href="{{ url_for('rental_management') }}" class="btn btn-info">
                        <i class="fas fa-arrow-right me-1"></i>å€Ÿè¿˜ç®¡ç†
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-chart-bar fa-3x text-secondary mb-3"></i>
                    <h5 class="card-title">ç»Ÿè®¡æŠ¥è¡¨</h5>
                    <p class="card-text">æŸ¥çœ‹é”€å”®å’Œå€Ÿè¿˜ç»Ÿè®¡æŠ¥è¡¨ï¼Œåˆ†æä¸šåŠ¡æ•°æ®å’Œè¶‹åŠ¿ã€‚</p>
                    <a href="{{ url_for('statistics') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-right me-1"></i>æŸ¥çœ‹æŠ¥è¡¨
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body text-center">
                    <i class="fas fa-database fa-3x text-dark mb-3"></i>
                    <h5 class="card-title">æ•°æ®å¤‡ä»½</h5>
                    <p class="card-text">å¤‡ä»½å’Œæ¢å¤ç³»ç»Ÿæ•°æ®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§ã€‚</p>
                    <a href="{{ url_for('backup_management') }}" class="btn btn-dark">
                        <i class="fas fa-arrow-right me-1"></i>æ•°æ®å¤‡ä»½
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿç‰¹ç‚¹ -->
    <div class="row mt-5">
        <div class="col-12">
            <h2 class="mb-4 text-center">ç³»ç»Ÿç‰¹ç‚¹</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="text-center">
                <i class="fas fa-bolt fa-2x text-warning mb-3"></i>
                <h5>è‡ªåŠ¨è§¦å‘</h5>
                <p class="text-muted">é”€å”®å’Œå€Ÿè¿˜æ“ä½œè‡ªåŠ¨æ›´æ–°åº“å­˜ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ã€‚</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="text-center">
                <i class="fas fa-chart-line fa-2x text-success mb-3"></i>
                <h5>æ™ºèƒ½ç»Ÿè®¡</h5>
                <p class="text-muted">åŸºäºèšåˆç®¡é“çš„é«˜æ•ˆç»Ÿè®¡åˆ†æï¼Œæ”¯æŒè‡ªå®šä¹‰æ—¶é—´æ®µã€‚</p>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="text-center">
                <i class="fas fa-shield-alt fa-2x text-primary mb-3"></i>
                <h5>æ•°æ®å®‰å…¨</h5>
                <p class="text-muted">å®Œå–„çš„æ•°æ®å¤‡ä»½æ¢å¤æœºåˆ¶ï¼Œä¿éšœæ•°æ®å®‰å…¨ã€‚</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    loadDashboardStats();
});

function refreshData() {
    notifications.showLoading('æ­£åœ¨åˆ·æ–°æ•°æ®...');
    loadDashboardStats();
    setTimeout(function() {
        notifications.hideLoading();
        notifications.success('æ•°æ®å·²åˆ·æ–°');
    }, 1000);
}

async function fixAllData() {
    const confirmed = await notifications.confirm(
        'æ•°æ®ä¿®å¤ç¡®è®¤',
        'è¿™å°†é‡æ–°è®¡ç®—æ‰€æœ‰åº“å­˜æ•°é‡ï¼Œæ¸…ç†æ— æ•ˆè®°å½•ï¼Œä¿®å¤æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
    );
    
    if (confirmed) {
        notifications.showLoading('æ­£åœ¨ä¿®å¤æ•°æ®ï¼Œè¯·ç¨å€™...');
        
        $.ajax({
            url: '/api/data/fix-all',
            method: 'POST',
            success: function(response) {
                notifications.hideLoading();
                if (response.success) {
                    let message = response.message;
                    if (response.details && response.details.length > 0) {
                        message += '\n\nä¿®å¤è¯¦æƒ…:\n' + response.details.join('\n');
                    }
                    if (response.validation_errors && response.validation_errors.length > 0) {
                        message += '\n\nè­¦å‘Š:\n' + response.validation_errors.join('\n');
                    }
                    
                    notifications.success('æ•°æ®ä¿®å¤å®Œæˆ');
                    
                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    setTimeout(async function() {
                        await notifications.confirm(
                            'ä¿®å¤ç»“æœ',
                            message
                        );
                        // åˆ·æ–°æ•°æ®
                        loadDashboardStats();
                    }, 500);
                    
                } else {
                    notifications.error('ä¿®å¤å¤±è´¥: ' + response.message);
                }
            },
            error: function() {
                notifications.hideLoading();
                notifications.error('ç½‘ç»œé”™è¯¯ï¼Œä¿®å¤å¤±è´¥');
            }
        });
    }
}

async function resetAllData() {
    const firstConfirm = await notifications.confirm(
        'âš ï¸ å±é™©æ“ä½œï¼šé‡ç½®æ‰€æœ‰æ•°æ®',
        'è­¦å‘Šï¼šæ­¤æ“ä½œå°†å½»åº•æ¸…ç©ºæ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼\n\nå°†è¢«æ¸…ç©ºçš„æ•°æ®ï¼š\nâ€¢ æ‰€æœ‰é”€å”®è®°å½•\nâ€¢ æ‰€æœ‰ç§Ÿå€Ÿå½’è¿˜è®°å½•\nâ€¢ æ‰€æœ‰å®¢æˆ·ä¿¡æ¯\nâ€¢ æ‰€æœ‰åº“å­˜è®°å½•\n\nä¿ç•™çš„æ•°æ®ï¼š\nâ€¢ VCDåŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€ç±»å‹ã€ä»·æ ¼ç­‰ï¼‰\n\næ¯ä¸ªVCDå°†é‡ç½®ä¸ºé»˜è®¤åº“å­˜10ä¸ªã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
    );
    
    if (firstConfirm) {
        // äºŒæ¬¡ç¡®è®¤
        const finalConfirm = await notifications.confirm(
            'ğŸš¨ æœ€åç¡®è®¤',
            'æ‚¨çœŸçš„ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸šåŠ¡æ•°æ®å—ï¼Ÿ\n\nè¿™æ˜¯æœ€åä¸€æ¬¡ç¡®è®¤æœºä¼šï¼'
        );
        
        if (finalConfirm) {
            notifications.showLoading('æ­£åœ¨é‡ç½®æ‰€æœ‰æ•°æ®ï¼Œè¯·ç¨å€™...');
            
            $.ajax({
                url: '/api/data/reset-all',
                method: 'POST',
                success: function(response) {
                    notifications.hideLoading();
                    if (response.success) {
                        let message = response.message;
                        if (response.details && response.details.length > 0) {
                            message += '\n\né‡ç½®è¯¦æƒ…:\n' + response.details.join('\n');
                        }
                        
                        notifications.success('æ•°æ®é‡ç½®å®Œæˆ');
                        
                        // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                        setTimeout(async function() {
                            await notifications.confirm(
                                'é‡ç½®æˆåŠŸ',
                                message + '\n\nç°åœ¨æ‚¨å¯ä»¥é‡æ–°å¼€å§‹å½•å…¥æ•°æ®äº†ï¼'
                            );
                            // åˆ·æ–°é¡µé¢
                            window.location.reload();
                        }, 500);
                        
                    } else {
                        notifications.error('é‡ç½®å¤±è´¥: ' + response.message);
                    }
                },
                error: function() {
                    notifications.hideLoading();
                    notifications.error('ç½‘ç»œé”™è¯¯ï¼Œé‡ç½®å¤±è´¥');
                }
            });
        }
    }
}

function loadDashboardStats() {
    // åŠ è½½åº“å­˜ç»Ÿè®¡
    $.get('/api/inventory', function(data) {
        let totalVcds = 0;
        let availableVcds = 0;
        let rentedVcds = 0;
        
        data.forEach(function(item) {
            totalVcds += item.total_quantity || 0;
            availableVcds += item.available_quantity || 0;
            // ç¡®ä¿ç§Ÿå€Ÿæ•°é‡ä¸ä¸ºè´Ÿæ•°
            rentedVcds += Math.max(0, item.rented_quantity || 0);
        });
        
        $('#totalVcds').text(totalVcds);
        $('#availableVcds').text(availableVcds);
        $('#rentedVcds').text(rentedVcds);
        
        // æ·»åŠ æœ€åæ›´æ–°æ—¶é—´
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN');
        $('#lastUpdateTime').text('æœ€åæ›´æ–°: ' + timeStr);
    });
    
    // åŠ è½½ä»Šæ—¥é”€å”®ç»Ÿè®¡
    const today = new Date().toISOString().split('T')[0];
    $.get('/api/statistics/sales?start_date=' + today + '&end_date=' + today, function(data) {
        let todaySales = 0;
        data.forEach(function(item) {
            todaySales += item.total_sold || 0;
        });
        $('#todaySales').text(todaySales);
    });
}
</script>
{% endblock %} 